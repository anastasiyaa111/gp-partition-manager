# Greenplum Auto Partition Manager 

**Partition Manager** — это утилита для автоматизации жизненного цикла партиций в Greenplum. Она решает главную проблему эксплуатации: **безопасное изменение схемы партиционирования без даунтайма зависимых сервисов.**

Этот скрипт партиционирует таблицу, сохраняя всю систему вокруг нее: ***View, Materialized View, Owner, Grants, Trigger***, уже добавленные ранее партиции.



###  Безопасность и Надежность

* **Dependency Preservation:** Автоматически находит, сохраняет и восстанавливает все зависимости, в том числе рекурсивные, при пересоздании таблиц. 
* **Corner Case Protection:** Предусмотрена и обработка граничных значений, вроде `9999-12-31`, так же есть защите от "дыр" в интервалах, а так же "кривых" значений. Внутри есть компонент анализатора, который рассматривает все возможные случаи.
* **Data Safety:** Предусмотрена атоматическая эвакуация данных из дефалтовой партиции при добавлении новых значений или интервалов. Данные защищены благодаря полной транзакционности.


##  Quick Start

Мы подготовили `docker-compose` стенд, который поднимает Greenplum, устанавливает утилиту и прогоняет тесты.

**1. Клонируйте репозиторий:**

```bash
git clone https://github.com/your-username/gp-partition-manager.git
cd gp-partition-manager
```

**2. Запустите стенд:**

```bash
docker-compose up -d
```

При первом запуске автоматически прогонится набор тестов (`src/tests.sql`). 
#### Проверьте статус прохождения тестов:
```
docker-compose logs -f gp-init
```

**3. Подключитесь к базе:**

* **Host:** `localhost`
* **Port:** `5432`
* **DB:** `demo_db`
* **User/Pass:** `gpadmin` / `gpadmin`

***

## Как это работает

### Архитектура процесса

Инструмент работает как конечный автомат:

1. **Parser:** Валидирует входящий JSON-массив.
2. **Analyzer:** Сравнивает желаемое состояние с системным каталогом. Если изменений не требуется или найдена ошибка во входных данных, работа завершается.
3. **Dependency Manager:** Сканирует все зависимости, сохраняя определения зависимых объектов во временные таблицы. После восстанавливает их в **правильном порядке**.
4. **Executor:** Генерирует DDL любой сложности, включая многоуровневое партиционирование.

### Пример вызова

```sql
SELECT partition_utils.srv_partition_mng($$
[
  {
    "schema_name": "public",
    "table_name": "sales_log",
    "partition_column": "event_dt",
    "partition_type": "range",
    "operation_plan": {
      "start_date": "2024-01-01",
      "end_date": "2025-01-01",
      "interval": "1 month"
    },
    "subpartition": {
      "partition_column": "region_code",
      "partition_type": "list",
      "operation_plan": {
        "definitions": ["RU", "US", "CN"]
      }
    }
  }
]
$$);
```


***

## Тестирование

Проект покрыт автоматическими тестами, которые проверяют:

1. Конвертация обычной Heap-таблицы в партиционированную без потери данных.
2. Расширение временного окна (Split Default).
3. Выделение значения из Default-партиции в отдельную именованную партицию (сложный кейс для GP 6).
4. Проверка на сохранение рекурсивных значений.
5. Проверка на выполнение для партиции и субпартиции разного типа.
6. Проверка на сохранение владельца таблицы и грантов.

Чтобы запустить тесты вручную на живой базе:

```bash
psql -d demo_db -f src/tests.sql
```


***


## License

Проект распространяется под лицензией **MIT**. Вы можете свободно использовать его в коммерческих проектах.

